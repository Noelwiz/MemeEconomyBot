Warning: this version has multiple outstanding bugs
